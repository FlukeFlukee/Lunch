<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü´èüç± ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡πÑ‡∏£‡∏î‡∏µ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="max-w-5xl mx-auto p-6">

    <h1 class="text-3xl font-bold text-pink-600 mb-4">ü´èüç± ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏¥‡∏ô‡πÑ‡∏£‡∏î‡∏µ</h1>

    <div id="todayOrderBox" class="mb-6 bg-white rounded-xl shadow p-6 text-center"></div>

    <form id="mainForm" class="space-y-6 bg-white shadow-xl p-6 rounded-2xl">

      <div>
        <h2 class="text-lg font-semibold mb-2">üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>
        <div id="userBlocks" class="space-y-4"></div>
        <button type="button" onclick="addUserBlock()"
          class="bg-red-700 text-white px-4 py-2 rounded-lg hover:bg-red-800">
          ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="font-medium">üí∏ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
          <input type="number" id="discount" class="w-full p-2 border rounded" value="0" min="0">
        </div>
        <div>
          <label class="font-medium">üöö ‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
          <input type="number" id="delivery" class="w-full p-2 border rounded" value="0" min="0">
        </div>
      </div>

      <div class="border-t pt-4">
        <h2 class="font-semibold mb-2">üí≥ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h2>

        <label class="inline-flex items-center gap-2">
          <input type="radio" name="payType" value="bank" checked>
          <span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</span>
        </label>

        <label class="inline-flex items-center gap-2 ml-4">
          <input type="radio" name="payType" value="promptpay">
          <span>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</span>
        </label>

        <div id="bankBox" class="mt-2">
          <select id="bankName" class="w-full p-2 border rounded">
            <option>‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option>
            <option>‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
            <option>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
            <option>‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</option>
            <option>‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ</option>
            <option>‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</option>
          </select>
          <input id="bankNumber" class="w-full p-2 border rounded mt-2" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
        </div>

        <div id="promptBox" class="mt-2 hidden">
          <input id="promptNumber" class="w-full p-2 border rounded" placeholder="‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå">
        </div>
      </div>

      <button type="submit"
        class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">
        ü´è ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
      </button>
    </form>

    <div id="resultSection" class="mt-8"></div>

    <div class="mt-6">
      <button onclick="toggleCalendar()"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        üìÖ ‡πÅ‡∏™‡∏î‡∏á / ‡∏ã‡πà‡∏≠‡∏ô ‡∏õ‡∏è‡∏¥‡∏ò‡∏¥‡∏ô
      </button>
      <div id="calendarSection" class="mt-4 hidden"></div>
    </div>

  </div>

  <script>
    /* ===== DATA ===== */
    const defaultUsers = ["‡∏û‡∏µ‡πà‡∏ü‡∏•‡∏∏‡πä‡∏Ñ", "‡∏û‡∏µ‡πà‡∏ã‡∏¥‡∏ô", "‡∏û‡∏µ‡πà‡∏ï‡∏±‡πä‡∏Å", "‡∏û‡∏µ‡πà‡πÇ‡∏£‡∏™", "‡∏û‡∏µ‡πà‡πÅ‡∏ö‡∏á‡∏Ñ‡πå", "‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏¢", "‡πÑ‡∏≠‡πà‡∏Ç‡∏ß‡∏±‡∏ç", "‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏ô","‡∏û‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å","‡∏û‡∏µ‡πà‡∏Å‡∏¥‡πä‡∏ü"];
    const orderPersons = ["‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏¢", "‡∏û‡∏µ‡πà‡∏ü‡∏•‡∏∏‡πä‡∏Ñ", "‡∏û‡∏µ‡πà‡πÇ‡∏£‡∏™", "‡πÑ‡∏≠‡πà‡∏Ç‡∏ß‡∏±‡∏ç", "‡∏û‡∏µ‡πà‡πÅ‡∏ö‡∏á‡∏Ñ‡πå","‡∏ô‡πâ‡∏≠‡∏á‡∏ã‡∏¥‡∏ô"];

    /* ===== HELPERS ===== */
    const thb = (n) => (Number(n || 0)).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function safeNumber(v) {
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }

    /* ===== USERS ===== */
    function createMenuRow() {
      const d = document.createElement("div");
      d.className = "grid grid-cols-2 gap-2";
      d.innerHTML = `
        <input class="food-name p-2 border rounded" placeholder="‡πÄ‡∏°‡∏ô‡∏π">
        <input class="food-price p-2 border rounded" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" min="0" step="0.01">
      `;
      return d;
    }

    function addUserBlock(name = "") {
      const userBlocks = document.getElementById("userBlocks");
      const d = document.createElement("div");
      d.className = "bg-gray-50 p-4 rounded-xl border border-gray-200";
      d.innerHTML = `
        <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-2">
          <input class="username p-2 border rounded w-full sm:w-64" value="${name}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á">
        </div>
        <div class="menu-list space-y-2"></div>
        <button type="button"
          class="bg-blue-500 text-white px-2 py-1 mt-3 rounded hover:bg-blue-600"
          onclick="addMenuToUser(this)">
          ‚ûï ‡πÄ‡∏°‡∏ô‡∏π
        </button>
      `;
      userBlocks.appendChild(d);
      d.querySelector(".menu-list").appendChild(createMenuRow());
    }

    function addMenuToUser(b) {
      b.parentElement.querySelector(".menu-list").appendChild(createMenuRow());
    }

    /* ===== SUBMIT ===== */
    document.getElementById("mainForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const discountValRaw = safeNumber(document.getElementById("discount").value);
      const deliveryVal = safeNumber(document.getElementById("delivery").value);

      // 1) collect orders + per-user totals
      const orders = [];
      const userTotals = {};   // { user: totalFood }
      const userItems = {};    // { user: [ {name, price} ] }

      document.querySelectorAll("#userBlocks > div").forEach(block => {
        const user = (block.querySelector(".username").value || "").trim() || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠";

        const names = block.querySelectorAll(".food-name");
        const prices = block.querySelectorAll(".food-price");

        for (let i = 0; i < prices.length; i++) {
          const price = safeNumber(prices[i].value);
          const name = (names[i].value || "").trim();

          // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ "‡∏£‡∏≤‡∏Ñ‡∏≤"
          if (price > 0) {
            orders.push({ user, name: name || "-", price });

            if (!userTotals[user]) userTotals[user] = 0;
            userTotals[user] += price;

            if (!userItems[user]) userItems[user] = [];
            userItems[user].push({ name: name || "-", price });
          }
        }
      });

      if (!orders.length) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π"); return; }

      // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏¥‡∏á
      const activeUsers = Object.keys(userTotals);
      const numUsers = activeUsers.length;

      const totalFood = orders.reduce((s, o) => s + o.price, 0);

      // 2) discount cap (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£)
      const discountVal = Math.min(Math.max(discountValRaw, 0), totalFood);

      // 3) delivery split equally
      const deliveryPerPerson = numUsers > 0 ? (deliveryVal / numUsers) : 0;

      // 4) weighted discount by food total
      const perUserSummary = activeUsers.map(user => {
        const foodTotal = userTotals[user];
        const weight = totalFood > 0 ? (foodTotal / totalFood) : 0;

        const discountShare = discountVal * weight;
        const discountPctOfUser = foodTotal > 0 ? (discountShare / foodTotal) * 100 : 0;

        const netPay = foodTotal - discountShare + deliveryPerPerson;

        return {
          user,
          foodTotal,
          weightPct: weight * 100,
          discountShare,
          discountPctOfUser,
          deliveryShare: deliveryPerPerson,
          netPay
        };
      });

      // totals
      const totalNet = perUserSummary.reduce((s, x) => s + x.netPay, 0);

      // 5) payment info
      const payType = document.querySelector("input[name=payType]:checked").value;
      const bankName = document.getElementById("bankName").value;
      const bankNumber = document.getElementById("bankNumber").value;
      const promptNumber = document.getElementById("promptNumber").value;

      const payInfo = payType === "bank"
        ? `üè¶ ${bankName} ${bankNumber || ""}`.trim()
        : `üì± ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå ${promptNumber || ""}`.trim();

      // 6) build order detail rows
      let orderRows = "";
      orders.forEach(o => {
        orderRows += `
          <tr class="border-t hover:bg-gray-50">
            <td class="px-3 py-2 text-left">${o.user}</td>
            <td class="px-3 py-2 text-left">${o.name}</td>
            <td class="px-3 py-2 text-right">${thb(o.price)}</td>
          </tr>
        `;
      });

      // 7) build summary rows
      // sort by netPay desc (optional, can remove if not want)
      perUserSummary.sort((a, b) => b.netPay - a.netPay);

      let summaryRows = "";
      perUserSummary.forEach(x => {
        summaryRows += `
          <tr class="border-t hover:bg-gray-50">
            <td class="px-3 py-2 text-left font-medium">${x.user}</td>
            <td class="px-3 py-2 text-right">${thb(x.foodTotal)}</td>
            <td class="px-3 py-2 text-right">${x.weightPct.toFixed(1)}%</td>
            <td class="px-3 py-2 text-right text-emerald-700 font-semibold">-${thb(x.discountShare)}</td>
            <td class="px-3 py-2 text-right text-blue-700 font-semibold">+${thb(x.deliveryShare)}</td>
            <td class="px-3 py-2 text-right text-pink-700 font-bold">${thb(x.netPay)}</td>
          </tr>
        `;
      });

      document.getElementById("resultSection").innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow">
          <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-4">
            <div>
              <h2 class="text-xl font-bold text-pink-700">üìä Summary</h2>
            </div>
          </div>

          <!-- ORDER DETAILS TABLE -->
          <div class="mb-6">
            <h3 class="font-semibold mb-2">üçΩÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
            <div class="overflow-x-auto rounded-xl border">
              <table class="w-full text-sm text-center">
                <thead class="bg-pink-100">
                  <tr>
                    <th class="px-3 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th class="px-3 py-2 text-left">‡πÄ‡∏°‡∏ô‡∏π</th>
                    <th class="px-3 py-2 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</th>
                  </tr>
                </thead>
                <tbody class="bg-white">
                  ${orderRows}
                </tbody>
              </table>
            </div>
          </div>

          <!-- PER PERSON SUMMARY TABLE -->
          <div>
            <h3 class="font-semibold mb-2">üßæ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>
            <div class="overflow-x-auto rounded-xl border">
              <table class="w-full text-sm text-center">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-3 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th class="px-3 py-2 text-right">‡∏¢‡∏≠‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th>
                    <th class="px-3 py-2 text-right">% ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á</th>
                    <th class="px-3 py-2 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ö‡∏≤‡∏ó)</th>
                    <th class="px-3 py-2 text-right">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á/‡∏Ñ‡∏ô</th>
                    <th class="px-3 py-2 text-right">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                  </tr>
                </thead>
                <tbody class="bg-white">
                  ${summaryRows}
                  <tr class="border-t bg-yellow-50">
                    <td class="px-3 py-2 text-left font-bold">‡∏£‡∏ß‡∏°</td>
                    <td class="px-3 py-2 text-right font-bold">${thb(totalFood)}</td>
                    <td class="px-3 py-2 text-right font-bold">100.0%</td>
                    <td class="px-3 py-2 text-right font-bold text-emerald-700">-${thb(discountVal)}</td>
                    <td class="px-3 py-2 text-right font-bold text-blue-700">+${thb(deliveryVal)}</td>
                    <td class="px-3 py-2 text-right font-extrabold text-pink-700">${thb(totalNet)}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div class="text-sm text-gray-700">
                ü´è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏™‡∏±‡πà‡∏á: <span class="font-semibold">${numUsers}</span>
              </div>
              <div class="text-sm font-medium">
                ${payInfo ? `<span class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded-xl inline-block">${payInfo}</span>` : ""}
              </div>
            </div>
          </div>

        </div>
      `;
    });

    /* ===== CALENDAR ===== */
    function businessDayIndex(startDate, targetDate) {
      const s = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
      const t = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
    
      const step = s <= t ? 1 : -1;
      let idx = 0;
      let d = new Date(s);
    
      while ((step === 1 && d <= t) || (step === -1 && d >= t)) {
        const day = d.getDay(); // 0 Sun ... 6 Sat
        const isWorkday = day !== 0 && day !== 6;
        if (isWorkday) idx += step;
        d.setDate(d.getDate() + step);
      }

      return idx - step;
    }

    function getOrderPersonForDate(dateObj) {
      const day = dateObj.getDay();
      if (day === 0 || day === 6) return "‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á";
      const anchor = new Date("2026-01-01T00:00:00");
      const idx = businessDayIndex(anchor, dateObj);
      const n = orderPersons.length;
      if (n === 0) return "‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á";
      const pos = ((idx % n) + n) % n;
    
      return orderPersons[pos];
    }
    function generateCalendarFixed(s, e) {
      const c = {};
      for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
        const key = d.toISOString().split("T")[0];
        c[key] = getOrderPersonForDate(d);
      }
      return c;
    }
    
    const calendarData = generateCalendarFixed(new Date("2026-01-01"), new Date("2030-12-31"));
    
    (function () {
      const todayKey = new Date().toISOString().split("T")[0];
      const who = calendarData[todayKey] || getOrderPersonForDate(new Date());
    
      document.getElementById("todayOrderBox").innerHTML =
        `<h2 class="text-2xl font-bold">üç± ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á</h2>
         <p class="text-3xl mt-2">${who}</p>`;
    })();
    
    function toggleCalendar() {
      const calendarSection = document.getElementById("calendarSection");
      calendarSection.classList.toggle("hidden");
      if (calendarSection.innerHTML) return;
    
      calendarSection.innerHTML = Object.entries(calendarData)
        .map(([d, p]) => `<div class="py-1">${d} : <b>${p}</b></div>`)
        .join("");
    }

    /* ===== PAY TYPE ===== */
    document.querySelectorAll("input[name=payType]").forEach(r => {
      r.onchange = () => {
        document.getElementById("bankBox").classList.toggle("hidden", r.value !== "bank");
        document.getElementById("promptBox").classList.toggle("hidden", r.value !== "promptpay");
      };
    });

    /* ===== INIT ===== */
    defaultUsers.forEach(addUserBlock);
  </script>
</body>
</html>



